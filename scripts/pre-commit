#!/bin/bash

# Luke Avenue Drive Gallery - Pre-commit Hook
# This hook runs quick checks before allowing commits

echo "⚡ Running pre-commit checks..."

# 変更されたファイルを取得
staged_files=$(git diff --cached --name-only)

# フロントエンド関連のファイルが変更された場合
if echo "$staged_files" | grep -q "frontend/"; then
    echo "📱 Frontend files changed - running linter..."
    cd frontend && npm run lint
    if [ $? -ne 0 ]; then
        echo "❌ Frontend linting failed!"
        echo "💡 Fix the linting errors and try again"
        exit 1
    fi
    echo "✅ Frontend linting passed"
    cd ..
fi

# バックエンド関連のファイルが変更された場合
if echo "$staged_files" | grep -q -E "\.(go|mod|sum)$"; then
    echo "🏗️  Backend files changed - running vet..."
    go vet ./...
    if [ $? -ne 0 ]; then
        echo "❌ Go vet failed!"
        echo "💡 Fix the vet issues and try again"
        exit 1
    fi
    echo "✅ Go vet passed"
    
    echo "🔨 Checking Go build..."
    go build -v ./...
    if [ $? -ne 0 ]; then
        echo "❌ Go build failed!"
        echo "💡 Fix the build errors and try again"
        exit 1
    fi
    echo "✅ Go build passed"
fi

# 大きなファイルをチェック (5MB以上)
large_files=$(git diff --cached --name-only | xargs -I {} du -k {} 2>/dev/null | awk '$1 > 5120 {print $2}')
if [ ! -z "$large_files" ]; then
    echo "⚠️  Large files detected (>5MB):"
    echo "$large_files"
    echo "💡 Consider using Git LFS for large files"
    echo "🚨 To bypass this check: git commit --no-verify"
    exit 1
fi

echo "🎉 Pre-commit checks passed!"
exit 0