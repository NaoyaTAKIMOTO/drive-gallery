#!/bin/bash

# Luke Avenue Drive Gallery - Pre-commit Hook
# This hook runs quick checks before allowing commits

echo "âš¡ Running pre-commit checks..."

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
staged_files=$(git diff --cached --name-only)

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–¢é€£ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
if echo "$staged_files" | grep -q "frontend/"; then
    echo "ðŸ“± Frontend files changed - running linter..."
    cd frontend && npm run lint
    if [ $? -ne 0 ]; then
        echo "âŒ Frontend linting failed!"
        echo "ðŸ’¡ Fix the linting errors and try again"
        exit 1
    fi
    echo "âœ… Frontend linting passed"
    cd ..
fi

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–¢é€£ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
if echo "$staged_files" | grep -q -E "\.(go|mod|sum)$"; then
    echo "ðŸ—ï¸  Backend files changed - running vet..."
    go vet ./...
    if [ $? -ne 0 ]; then
        echo "âŒ Go vet failed!"
        echo "ðŸ’¡ Fix the vet issues and try again"
        exit 1
    fi
    echo "âœ… Go vet passed"
    
    echo "ðŸ”¨ Checking Go build..."
    go build -v ./...
    if [ $? -ne 0 ]; then
        echo "âŒ Go build failed!"
        echo "ðŸ’¡ Fix the build errors and try again"
        exit 1
    fi
    echo "âœ… Go build passed"
fi

# å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ (5MBä»¥ä¸Š)
large_files=$(git diff --cached --name-only | xargs -I {} du -k {} 2>/dev/null | awk '$1 > 5120 {print $2}')
if [ ! -z "$large_files" ]; then
    echo "âš ï¸  Large files detected (>5MB):"
    echo "$large_files"
    echo "ðŸ’¡ Consider using Git LFS for large files"
    echo "ðŸš¨ To bypass this check: git commit --no-verify"
    exit 1
fi

echo "ðŸŽ‰ Pre-commit checks passed!"
exit 0