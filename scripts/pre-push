#!/bin/bash

# Luke Avenue Drive Gallery - Pre-push Hook
# This hook runs tests before allowing git push

echo "ğŸ” Running pre-push tests..."

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
current_branch=$(git branch --show-current)

# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã®å ´åˆã¯ã‚ˆã‚Šå³æ ¼ãªãƒã‚§ãƒƒã‚¯
if [ "$current_branch" = "main" ]; then
    echo "âš ï¸  Pushing to main branch - running full test suite"
    test_target="test"
else
    echo "ğŸ“ Pushing to feature branch - running essential tests"
    test_target="test-essential"
fi

# ãƒ†ã‚¹ãƒˆãŒé€šã‚‰ãªã„å ´åˆã®å‡¦ç†
run_tests() {
    echo "ğŸ§ª Running $test_target..."
    
    if make $test_target; then
        echo "âœ… All tests passed!"
        return 0
    else
        echo "âŒ Tests failed!"
        echo ""
        echo "ğŸ’¡ To fix this:"
        echo "   1. Run 'make test' to see which tests are failing"
        echo "   2. Fix the failing tests"
        echo "   3. Try pushing again"
        echo ""
        echo "ğŸš¨ To bypass this check (NOT recommended):"
        echo "   git push --no-verify"
        echo ""
        return 1
    fi
}

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
changed_files=$(git diff --name-only HEAD~1..HEAD)

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
if echo "$changed_files" | grep -q "frontend/"; then
    echo "ğŸ“± Frontend files changed - including frontend tests"
    frontend_changed=true
fi

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
if echo "$changed_files" | grep -q -E "\.(go|mod|sum)$"; then
    echo "ğŸ—ï¸  Backend files changed - including backend tests"
    backend_changed=true
fi

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
if ! run_tests; then
    echo "ğŸ›‘ Push aborted due to test failures"
    exit 1
fi

echo "ğŸ‰ Pre-push checks passed - proceeding with push"
exit 0