#!/bin/bash

# Luke Avenue Drive Gallery - Pre-push Hook
# This hook runs tests before allowing git push

echo "🔍 Running pre-push tests..."

# 現在のブランチを取得
current_branch=$(git branch --show-current)

# mainブランチへのpushの場合はより厳格なチェック
if [ "$current_branch" = "main" ]; then
    echo "⚠️  Pushing to main branch - running full test suite"
    test_target="test"
else
    echo "📝 Pushing to feature branch - running essential tests"
    test_target="test-essential"
fi

# テストが通らない場合の処理
run_tests() {
    echo "🧪 Running $test_target..."
    
    if make $test_target; then
        echo "✅ All tests passed!"
        return 0
    else
        echo "❌ Tests failed!"
        echo ""
        echo "💡 To fix this:"
        echo "   1. Run 'make test' to see which tests are failing"
        echo "   2. Fix the failing tests"
        echo "   3. Try pushing again"
        echo ""
        echo "🚨 To bypass this check (NOT recommended):"
        echo "   git push --no-verify"
        echo ""
        return 1
    fi
}

# 変更されたファイルをチェック
changed_files=$(git diff --name-only HEAD~1..HEAD)

# フロントエンドファイルが変更された場合
if echo "$changed_files" | grep -q "frontend/"; then
    echo "📱 Frontend files changed - including frontend tests"
    frontend_changed=true
fi

# バックエンドファイルが変更された場合
if echo "$changed_files" | grep -q -E "\.(go|mod|sum)$"; then
    echo "🏗️  Backend files changed - including backend tests"
    backend_changed=true
fi

# テスト実行
if ! run_tests; then
    echo "🛑 Push aborted due to test failures"
    exit 1
fi

echo "🎉 Pre-push checks passed - proceeding with push"
exit 0